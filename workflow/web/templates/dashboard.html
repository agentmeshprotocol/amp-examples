{% extends "base.html" %}

{% block title %}Dashboard - AMP Workflow{% endblock %}

{% block content %}
<!-- Status Cards Row -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Active Workflows</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeWorkflows">-</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-play fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Success Rate</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="successRate">-</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Running Tasks</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="runningTasks">-</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tasks fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Recent Errors</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="recentErrors">-</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Performance Chart -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Performance Overview</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow">
                        <div class="dropdown-header">Time Range:</div>
                        <a class="dropdown-item" href="#" onclick="updatePerformanceChart('1h')">Last Hour</a>
                        <a class="dropdown-item" href="#" onclick="updatePerformanceChart('24h')">Last 24 Hours</a>
                        <a class="dropdown-item" href="#" onclick="updatePerformanceChart('7d')">Last 7 Days</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Health</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="small mb-1">Workflow Engine</div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="engineHealth" style="width: 100%">100%</div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="small mb-1">Task Executors</div>
                    <div class="progress">
                        <div class="progress-bar bg-info" id="executorHealth" style="width: 95%">95%</div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="small mb-1">State Manager</div>
                    <div class="progress">
                        <div class="progress-bar bg-warning" id="stateHealth" style="width: 85%">85%</div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="small mb-1">Monitor Agent</div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="monitorHealth" style="width: 100%">100%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Alerts Row -->
<div class="row">
    <!-- Recent Workflows -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Recent Workflow Executions</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="recentWorkflowsTable">
                        <thead>
                            <tr>
                                <th>Workflow</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Started</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Alerts -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Recent Alerts</h6>
            </div>
            <div class="card-body">
                <div id="recentAlertsList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary btn-block" onclick="showStartWorkflowModal()">
                            <i class="fas fa-play me-2"></i>Start Workflow
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-success btn-block" onclick="uploadWorkflow()">
                            <i class="fas fa-upload me-2"></i>Upload Workflow
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-info btn-block" onclick="viewSystemMetrics()">
                            <i class="fas fa-chart-bar me-2"></i>View Metrics
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-secondary btn-block" onclick="exportLogs()">
                            <i class="fas fa-download me-2"></i>Export Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Start Workflow Modal -->
<div class="modal fade" id="startWorkflowModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Workflow</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="startWorkflowForm">
                    <div class="mb-3">
                        <label for="workflowSelect" class="form-label">Select Workflow</label>
                        <select class="form-select" id="workflowSelect" required>
                            <option value="">Choose a workflow...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="workflowInputs" class="form-label">Input Parameters (JSON)</label>
                        <textarea class="form-control" id="workflowInputs" rows="5" placeholder='{"key": "value"}'>{}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startSelectedWorkflow()">Start Workflow</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Dashboard-specific JavaScript
let performanceChart;
let dashboardData = {};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    setupWebSocket();
    setInterval(refreshDashboard, 30000); // Refresh every 30 seconds
});

async function initializeDashboard() {
    showLoading(true);
    try {
        await loadDashboardData();
        await loadWorkflowList();
        initializePerformanceChart();
    } catch (error) {
        console.error('Failed to initialize dashboard:', error);
        showToast('Failed to load dashboard data', 'error');
    } finally {
        showLoading(false);
    }
}

async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard');
        if (response.ok) {
            dashboardData = await response.json();
            updateDashboardCards();
            updateRecentWorkflows();
            updateRecentAlerts();
        } else {
            throw new Error('Failed to load dashboard data');
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        throw error;
    }
}

function updateDashboardCards() {
    const overview = dashboardData.overview || {};
    
    document.getElementById('activeWorkflows').textContent = overview.active_workflows || 0;
    document.getElementById('successRate').textContent = (overview.success_rate || 0).toFixed(1) + '%';
    document.getElementById('runningTasks').textContent = overview.running_tasks || 0;
    document.getElementById('recentErrors').textContent = overview.recent_errors || 0;
}

function updateRecentWorkflows() {
    const workflows = dashboardData.workflows?.recent_executions || [];
    const tbody = document.querySelector('#recentWorkflowsTable tbody');
    
    tbody.innerHTML = '';
    
    workflows.slice(0, 5).forEach(workflow => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${workflow.workflow_id || 'Unknown'}</td>
            <td><span class="badge bg-${getStatusColor(workflow.status)}">${workflow.status}</span></td>
            <td>${formatDuration(workflow.execution_time)}</td>
            <td>${formatTime(workflow.started_at)}</td>
        `;
    });
    
    if (workflows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No recent workflows</td></tr>';
    }
}

function updateRecentAlerts() {
    const alerts = dashboardData.alerts?.active_alerts || [];
    const container = document.getElementById('recentAlertsList');
    
    container.innerHTML = '';
    
    alerts.slice(0, 5).forEach(alert => {
        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${getSeverityColor(alert.severity)} alert-dismissible`;
        alertElement.innerHTML = `
            <i class="fas fa-${getSeverityIcon(alert.severity)} me-2"></i>
            <strong>${alert.title}</strong><br>
            <small>${alert.description}</small>
            <small class="text-muted d-block">${formatTime(alert.created_at)}</small>
        `;
        container.appendChild(alertElement);
    });
    
    if (alerts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No recent alerts</div>';
    }
}

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], // Will be populated with time labels
            datasets: [{
                label: 'Active Workflows',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.1
            }, {
                label: 'Success Rate %',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    updatePerformanceChart('1h');
}

async function updatePerformanceChart(timeRange) {
    try {
        const response = await fetch(`/api/metrics?time_range=${timeRange}`);
        if (response.ok) {
            const metrics = await response.json();
            // Update chart with new data
            // This would need to be implemented based on actual metrics structure
        }
    } catch (error) {
        console.error('Error updating performance chart:', error);
    }
}

async function loadWorkflowList() {
    try {
        const response = await fetch('/api/workflows');
        if (response.ok) {
            const workflows = await response.json();
            const select = document.getElementById('workflowSelect');
            
            select.innerHTML = '<option value="">Choose a workflow...</option>';
            
            Object.keys(workflows).forEach(workflowId => {
                const option = document.createElement('option');
                option.value = workflowId;
                option.textContent = workflows[workflowId].name || workflowId;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading workflow list:', error);
    }
}

function setupWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
    
    ws.onopen = function() {
        updateConnectionStatus(true);
    };
    
    ws.onmessage = function(event) {
        const message = JSON.parse(event.data);
        handleWebSocketMessage(message);
    };
    
    ws.onclose = function() {
        updateConnectionStatus(false);
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            setupWebSocket();
        }, 5000);
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        updateConnectionStatus(false);
    };
}

function handleWebSocketMessage(message) {
    switch (message.type) {
        case 'workflow_event':
            handleWorkflowEvent(message.data);
            break;
        case 'task_event':
            handleTaskEvent(message.data);
            break;
        case 'error_event':
            handleErrorEvent(message.data);
            break;
        default:
            console.log('Unknown message type:', message.type);
    }
}

function handleWorkflowEvent(data) {
    // Update UI based on workflow event
    showToast(`Workflow ${data.event_type}: ${data.workflow_instance_id}`, 'info');
    refreshDashboard();
}

function handleTaskEvent(data) {
    // Update UI based on task event
    refreshDashboard();
}

function handleErrorEvent(data) {
    // Show error notification
    showToast(`Error occurred: ${data.error?.message || 'Unknown error'}`, 'error');
    refreshDashboard();
}

function updateConnectionStatus(connected) {
    const statusIcon = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    
    if (connected) {
        statusIcon.className = 'fas fa-circle text-success me-1';
        statusText.textContent = 'Connected';
    } else {
        statusIcon.className = 'fas fa-circle text-danger me-1';
        statusText.textContent = 'Disconnected';
    }
}

async function refreshDashboard() {
    try {
        await loadDashboardData();
    } catch (error) {
        console.error('Error refreshing dashboard:', error);
    }
}

function showStartWorkflowModal() {
    const modal = new bootstrap.Modal(document.getElementById('startWorkflowModal'));
    modal.show();
}

async function startSelectedWorkflow() {
    const workflowId = document.getElementById('workflowSelect').value;
    const inputsText = document.getElementById('workflowInputs').value;
    
    if (!workflowId) {
        showToast('Please select a workflow', 'warning');
        return;
    }
    
    let inputs = {};
    try {
        inputs = JSON.parse(inputsText);
    } catch (error) {
        showToast('Invalid JSON in input parameters', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/workflows/${workflowId}/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ workflow_id: workflowId, inputs: inputs })
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(`Workflow started successfully. Instance ID: ${result.instance_id}`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('startWorkflowModal')).hide();
            refreshDashboard();
        } else {
            const error = await response.json();
            showToast(`Failed to start workflow: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Error starting workflow:', error);
        showToast('Error starting workflow', 'error');
    }
}

// Utility functions
function getStatusColor(status) {
    const colors = {
        'completed': 'success',
        'running': 'primary',
        'failed': 'danger',
        'paused': 'warning',
        'pending': 'secondary'
    };
    return colors[status] || 'secondary';
}

function getSeverityColor(severity) {
    const colors = {
        'critical': 'danger',
        'error': 'danger',
        'warning': 'warning',
        'info': 'info'
    };
    return colors[severity] || 'info';
}

function getSeverityIcon(severity) {
    const icons = {
        'critical': 'exclamation-triangle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return icons[severity] || 'info-circle';
}

function formatDuration(seconds) {
    if (!seconds) return '-';
    if (seconds < 60) return `${seconds.toFixed(1)}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.floor(seconds % 60)}s`;
    return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
}

function formatTime(timestamp) {
    if (!timestamp) return '-';
    return new Date(timestamp).toLocaleString();
}

function uploadWorkflow() {
    // Implementation for workflow upload
    window.location.href = '/workflows';
}

function viewSystemMetrics() {
    window.location.href = '/monitoring';
}

function exportLogs() {
    // Implementation for log export
    showToast('Log export functionality coming soon', 'info');
}
</script>
{% endblock %}